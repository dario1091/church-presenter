<?xml version="1.0" encoding="UTF-8"?>
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ChurchPresenter.ViewModels"
             xmlns:models="using:ChurchPresenter.Models"
             xmlns:services="using:ChurchPresenter.Services"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="800"
             x:Class="ChurchPresenter.Views.BibleView"
             x:DataType="vm:BibleViewModel">

  <DockPanel>
    <!-- VersiÃ³n de la Biblia -->
    <ComboBox DockPanel.Dock="Top"
              ItemsSource="{Binding Bibles}"
              SelectedItem="{Binding SelectedBible}"
              HorizontalAlignment="Stretch"
              Margin="10,10,10,5">
      <ComboBox.ItemTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding Name}"/>
        </DataTemplate>
      </ComboBox.ItemTemplate>
    </ComboBox>

    <!-- TabControl para bÃºsqueda normal y semÃ¡ntica -->
    <TabControl Margin="10,5,10,10">
      <!-- PestaÃ±a: BÃºsqueda por Cita -->
      <TabItem Header="Por Cita">
        <Grid RowDefinitions="Auto,*" Margin="0,10,0,0">
          <!-- SelecciÃ³n de libro, capÃ­tulo y versÃ­culo -->
          <Grid Grid.Row="0" 
                ColumnDefinitions="2*,Auto,*,Auto,*"
                Margin="0,0,0,10">
        
        <AutoCompleteBox Grid.Column="0"
                        Name="bookAutoComplete"
                        ItemsSource="{Binding Books}"
                        Text="{Binding BookSearchText}"
                        FilterMode="Custom"
                        Watermark="Libro..."
                        MinimumPrefixLength="1"
                        SelectionChanged="OnBookSelected"/>
        
        <TextBlock Grid.Column="1" 
                   Text=" : " 
                   VerticalAlignment="Center"
                   Margin="5,0"/>
        
        <TextBox Grid.Column="2"
                 Text="{Binding SelectedChapterText}"
                 Width="60"
                 VerticalAlignment="Center"/>
        
        <TextBlock Grid.Column="3" 
                  Text=" : " 
                  VerticalAlignment="Center"
                  Margin="5,0"/>
        
        <TextBox Grid.Column="4"
                 Text="{Binding SelectedVerseText}"
                 Width="60"
                 VerticalAlignment="Center"/>
      </Grid>

      <!-- Lista de versÃ­culos -->
      <ListBox Grid.Row="1"
               ItemsSource="{Binding Verses}"
               SelectedItem="{Binding SelectedVerse}"
               SelectionMode="Single"
               Background="Transparent"
               BorderThickness="0">
        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
          </Style>
          <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
          </Style>
          <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
          </Style>
        </ListBox.Styles>
        <ListBox.ItemTemplate>
          <DataTemplate>
            <TextBlock TextWrapping="Wrap">
              <Run Text="{Binding Key}" FontWeight="Bold"/>
              <Run Text=". "/>
              <Run Text="{Binding Value}"/>
            </TextBlock>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </Grid>
  </TabItem>

  <!-- PestaÃ±a: BÃºsqueda SemÃ¡ntica -->
  <TabItem Header="Por Texto (IA)">
    <Grid RowDefinitions="Auto,*,Auto" Margin="0,10,0,0">
      <!-- Encabezado estilo chat IA -->
      <Border Grid.Row="0"
              Background="#F0F4F8"
              CornerRadius="8"
              Padding="15,12"
              Margin="0,0,0,15">
        <StackPanel Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="10">
            <TextBlock Text="ðŸ¤–"
                       FontSize="20"
                       VerticalAlignment="Center"/>
            <TextBlock Text="Asistente BÃ­blico IA"
                       FontSize="16"
                       FontWeight="Bold"
                       VerticalAlignment="Center"/>
          </StackPanel>
          <TextBlock Text="PregÃºntame sobre cualquier contenido de la Biblia. No necesitas la cita exacta, solo describe lo que recuerdas."
                     TextWrapping="Wrap"
                     FontSize="12"
                     Foreground="#666"
                     Margin="30,0,0,0"/>
          <TextBlock Text="{Binding IndexingProgress}"
                     IsVisible="{Binding IsIndexing}"
                     Foreground="#FF6B35"
                     FontWeight="SemiBold"
                     FontSize="11"
                     Margin="30,0,0,0"/>
        </StackPanel>
      </Border>

      <!-- Resultados de bÃºsqueda con estilo conversacional -->
      <ScrollViewer Grid.Row="1">
        <ItemsControl ItemsSource="{Binding SearchResults}">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="services:VerseSearchResult">
              <Border Margin="10,5"
                      Background="White"
                      BorderBrush="#E0E0E0"
                      BorderThickness="1"
                      CornerRadius="12"
                      Padding="15"
                      BoxShadow="0 2 8 0 #10000000"
                      DoubleTapped="OnSearchResultDoubleTapped"
                      Cursor="Hand">
                <StackPanel Spacing="8">
                  <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="{Binding Citation}"
                               FontWeight="SemiBold"
                               FontSize="13"
                               Foreground="#2563EB"/>
                    <Border Grid.Column="1"
                            Background="#DBEAFE"
                            CornerRadius="10"
                            Padding="8,4">
                      <TextBlock Text="{Binding Similarity, StringFormat='{}{0:P0}'}"
                                 FontSize="10"
                                 FontWeight="Medium"
                                 Foreground="#1E40AF"/>
                    </Border>
                  </Grid>
                  <TextBlock Text="{Binding Text}"
                             TextWrapping="Wrap"
                             FontSize="13"
                             LineHeight="20"
                             Foreground="#374151"/>
                </StackPanel>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>

      <!-- Input estilo chat en la parte inferior -->
      <Border Grid.Row="2"
              Background="White"
              BorderBrush="#E5E7EB"
              BorderThickness="0,1,0,0"
              Padding="15,12">
        <Grid ColumnDefinitions="*,Auto">
          <TextBox Grid.Column="0"
                   Text="{Binding SemanticSearchText}"
                   Watermark="ðŸ’¬ Escribe tu pregunta o describe el versÃ­culo que buscas..."
                   BorderThickness="1"
                   BorderBrush="#D1D5DB"
                   CornerRadius="20"
                   Padding="15,10"
                   FontSize="13"
                   Margin="0,0,10,0">
            <TextBox.KeyBindings>
              <KeyBinding Gesture="Enter" Command="{Binding SemanticSearchCommand}"/>
            </TextBox.KeyBindings>
          </TextBox>
          <Button Grid.Column="1"
                  Content="âž¤"
                  Command="{Binding SemanticSearchCommand}"
                  IsEnabled="{Binding !IsSearching}"
                  Width="45"
                  Height="45"
                  FontSize="18"
                  Background="#2563EB"
                  Foreground="White"
                  CornerRadius="22.5"
                  BorderThickness="0"
                  HorizontalContentAlignment="Center"
                  VerticalContentAlignment="Center"
                  Cursor="Hand"/>
        </Grid>
      </Border>
    </Grid>
  </TabItem>
</TabControl>
  </DockPanel>
</UserControl>